stages:
  - install
  - test
  - push
  - dbt

variables:
  PIP_CACHE_DIR: "$CI_PROJECT_DIR/.cache/pip"
  DOCKER_TLS_CERTDIR: ""

cache:
  key: ${CI_COMMIT_REF_SLUG}
  paths:
    - .cache/pip

# Install python deps found in the repo
install_dependencies:
  stage: install
  image: python:3.11
  script:
    - make install

# Run tests when present
run_tests:
  stage: test
  image: python:3.11
  script:
    - make test

# Build and push images to GitLab Container Registry
# Each image is pushed to: $CI_REGISTRY_IMAGE/<service>:<short-sha>
docker_push:
  stage: push
  image: docker:24
  services:
    - name: docker:24-dind
  variables:
    DOCKER_DRIVER: overlay2
    DOCKER_TLS_CERTDIR: ""
  before_script:
    - apk add --no-cache bash findutils
    - echo "$CI_REGISTRY_PASSWORD" | docker login -u "$CI_REGISTRY_USER" --password-stdin "$CI_REGISTRY"
  script:
    - make build-and-push REGISTRY="$CI_REGISTRY_IMAGE" TAG="$CI_COMMIT_SHORT_SHA"

# Lightweight dbt check if dbt exists
dbt_validate:
  stage: dbt
  image: python:3.11
  script:
    - make dbt-compile
